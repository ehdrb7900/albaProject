<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.alba.dao.IAlbaDAO">
	<sql id="searchFrag">
		<where>
		    <if test="searchVO!=null">
		    	<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(searchVO.searchWord)">
		    		<choose>
		    			<when test="'name'.equals(searchVO.searchType)">
			    			INSTR(AL_NAME, #{searchVO.searchWord}) > 0
		    			</when>
		    			<when test="'address'.equals(searchVO.searchType)">
			    			INSTR(AL_ADDRESS, #{searchVO.searchWord}) > 0
		    			</when>
		    			<when test="'career'.equals(searchVO.searchType)">
			    			INSTR(AL_CAREER, #{searchVO.searchWord}) > 0
		    			</when>
		    			<otherwise>
			    			INSTR(AL_NAME, #{searchVO.searchWord}) > 0
			    			OR INSTR(AL_ADDRESS, #{searchVO.searchWord}) > 0
			    			OR INSTR(AL_CAREER, #{searchVO.searchWord}) > 0
		    			</otherwise>
		    		</choose>
		    	</if>
		    </if>
	    </where>
	</sql>	
	
	
	<select id="selectAlbaList" resultType="AlbaVO" parameterType="PagingVO">
		SELECT B.*
		FROM(
		SELECT A.*, ROWNUM RNUM
		FROM (
			SELECT
			   	AL_ID, AL_NAME, AL_AGE,
				AL_ADDRESS, AL_HP, AL_SPEC,
				AL_DESC, GR_CODE, AL_CAREER,
				AL_GEN, AL_BTYPE, AL_MAIL
			FROM   ALBA
			<include refid="searchFrag" />
			ORDER BY AL_ID
		)	A	) B
		WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<select id="selectAlbaCount" resultType="int" parameterType="PagingVO">
		SELECT COUNT(*)
		FROM ALBA
		<include refid="searchFrag" />
	</select>
	
 	<resultMap type="AlbaVO" id="albaMap" autoMapping="true">
		<id property="al_id" column="AL_ID"/>
		<!-- has a 관계(1:1)일때 바인드방법1 -->
		<association property="grade" javaType="GradeVO" autoMapping="true"> 
			<result property="gr_name" column="GR_NAME"/>
		</association>
		
		<collection property="licenseList" javaType="java.util.List" ofType="LicenseVO" autoMapping="true"></collection>
	</resultMap>
	<select id="selectAlba" parameterType="String" resultMap="albaMap">
		 SELECT
			    A.AL_ID,		    AL_NAME,		    AL_AGE,		    AL_ADDRESS,
			    AL_HP,		    AL_SPEC,		    AL_DESC,		A.GR_CODE,
			    AL_CAREER,		AL_GEN,		    	AL_BTYPE,		AL_MAIL
			    , GR_NAME
			    , C.LIC_CODE, LIC_NAME
		FROM ALBA A INNER JOIN GRADE B ON (A.GR_CODE = B.GR_CODE)
		            LEFT OUTER JOIN LIC_ALBA C ON (A.AL_ID = C.AL_ID)
		            LEFT OUTER JOIN LICENSE D ON (C.LIC_CODE = D.LIC_CODE)
		 	WHERE  A.AL_ID = #{al_id} 
	
	</select>


</mapper>